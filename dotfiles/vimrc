" First, be iMproved
set nocompatible

" Figure out where we are (run vim with `vim --cmd 'let at_google=0'` to skip)
if !exists('at_google')
  let at_google = system('hostname') =~ 'google.com' && system('uname') != 'Darwin'
endif

" Plugins load faster with this off
filetype off

" Start Vundle loading
set runtimepath+=~/.vim/bundle/Vundle.vim
call vundle#begin()

" Load location specific plugins
if at_google
  source ~/.vimrc_google
else
  Plugin 'Blackrush/vim-gocode'
  Plugin 'Valloric/YouCompleteMe'
  Plugin 'tpope/vim-fugitive'
endif

" Load remaining plugins
Plugin 'Lokaltog/vim-easymotion'
Plugin 'MarcWeber/vim-addon-mw-utils'
Plugin 'christoomey/vim-tmux-navigator'
Plugin 'garbas/vim-snipmate'
Plugin 'gmarik/Vundle.vim'
Plugin 'jlund3/colorschemer'
Plugin 'kien/ctrlp.vim'
Plugin 'majutsushi/tagbar'
Plugin 'mileszs/ack.vim'
Plugin 'scrooloose/nerdcommenter'
Plugin 'scrooloose/nerdtree'
Plugin 'scrooloose/syntastic'
Plugin 'tomtom/tlib_vim'
Plugin 'tpope/vim-repeat'

" Done loading plugins
call vundle#end()

" Turn on file type based options
syntax on
filetype on
filetype indent on
filetype plugin on
let g:tex_flavor="latex"

" Turn on a few more options
set title
set backspace=2
set scrolloff=2
set showcmd
set showmode
set guioptions=ace
set colorcolumn=81
set number
set relativenumber
set wrap
set ttyfast

" Even more options for vsplits
set winwidth=84
autocmd WinEnter * setlocal number relativenumber wrap
autocmd WinLeave * setlocal nonumber norelativenumber nowrap

" In memory buffers
set nobackup
set noswapfile
set hidden

" Switch up the colors
set t_Co=256
set t_ut=
colorscheme lucid

" Setup statusline
set laststatus=2
set statusline=%<
set statusline+=%t
set statusline+=\ %([%Y%R%H%W]%)
set statusline+=%m
if !at_google
  set statusline+=%{fugitive#statusline()}
endif
set statusline+=%{SyntasticStatuslineFlag()}
set statusline+=\ %{&spell?\"SPELL\ \":\"\"}
set statusline+=%{&paste?\"PASTE\":\"\"}
set statusline+=%=
set statusline+=%-14.(%l,%v%)
set statusline+=\ %P

" Setup cursorline
autocmd WinEnter * setlocal cursorline
autocmd BufEnter * setlocal cursorline
autocmd WinLeave * setlocal nocursorline
setlocal cursorline

" More sane split openings
set splitbelow
set splitright

" Set the leader keys
let mapleader=" "
let maplocalleader="-"

" Better whitespace
if at_google
  set list listchars=tab:»\ ,nbsp:·
else
  set list listchars=tab:»\ ,trail:·,nbsp:·
endif
set expandtab
set textwidth=79
set tabstop=4
set softtabstop=4
set shiftwidth=4
set autoindent

" Handle trailing whitespace
nnoremap <silent> <leader><space> :call StripTrailingWhitespace()<cr>
function! StripTrailingWhitespace()
    let l=line(".")
    let c=col(".")
    execute '%s/\s\+$//e'
    call cursor(l, c)
endfunction

" Setup search
set hlsearch
set incsearch
set ignorecase
set smartcase
nnoremap <silent> <leader>/ :nohlsearch<cr>

" Setup NERDTree
nnoremap <silent> <leader>n :NERDTreeToggle<cr>
let NERDTreeIgnore=[]
let NERDTreeIgnore+=['\.pyc$', '__pycache__']
let NERDTreeIgnore+=['\.o$', '\.d$']
let NERDTreeIgnore+=['\.aux$', '\.log$']
let NERDTreeIgnore+=['\.class$']
let NERDTreeQuitOnOpen=1
let NERDTreeChDirMode=2

" Setup CtrlP
let g:ctrlp_custom_ignore = {
    \ 'dir':  '\v[\/]\.(git|hg|svn)$',
    \ 'file': '\v\.(pyc)$',
    \ }
let g:ctrlp_working_path_mode = 'rc'

" Setup Tagbar
nnoremap <silent> <leader>t :TagbarToggle<cr>
let g:tagbar_autoclose=1
let g:tagbar_left=1
let g:tagbar_sort=0
let g:tagbar_type_go = {
    \ 'ctagstype' : 'go',
    \ 'kinds'     : [
        \ 'p:package',
        \ 'i:imports:1',
        \ 'c:constants',
        \ 'v:variables',
        \ 't:types',
        \ 'n:interfaces',
        \ 'w:fields',
        \ 'e:embedded',
        \ 'm:methods',
        \ 'r:constructor',
        \ 'f:functions'
    \ ],
    \ 'sro' : '.',
    \ 'kind2scope' : {
        \ 't' : 'ctype',
        \ 'n' : 'ntype'
    \ },
    \ 'scope2kind' : {
        \ 'ctype' : 't',
        \ 'ntype' : 'n'
    \ },
    \ 'ctagsbin'  : 'gotags',
    \ 'ctagsargs' : '-sort -silent'
\ }
let g:tagbar_type_tex = {
    \ 'ctagstype' : 'latex',
    \ 'kinds'     : [
        \ 's:sections',
        \ 'g:graphics:0:0',
        \ 'l:labels',
        \ 'r:refs:1:0',
        \ 'p:pagerefs:1:0'
    \ ],
    \ 'sort'    : 0,
\ }

" Setup YouCompleteMe
let g:ycm_autoclose_preview_window_after_insertion=1
let g:ycm_key_list_select_completion=[]
let g:ycm_key_list_previous_completion=[]
let g:ycm_server_log_level='error'
let g:ycm_key_detailed_diagnostics=''
let g:ycm_path_to_python_interpreter = '/usr/bin/python'

" Setup Syntastic
let g:syntastic_check_on_open = 1

" Setup ack.vim
let g:ack_autoclose=1
nnoremap <leader>A :Ack <c-r><c-w><cr>
nnoremap <leader>a :Ack ""<left>
nnoremap <silent> <leader>d :Ack "TODO\|FIXME\|XXX"<cr>

" Setup vim-tmux-navigator
let g:tmux_navigator_no_mappings=1
nnoremap <silent> <c-h> :TmuxNavigateLeft<cr>
nnoremap <silent> <c-l> :TmuxNavigateRight<cr>
nnoremap <silent> <c-j> :TmuxNavigateDown<cr>
nnoremap <silent> <c-k> :TmuxNavigateUp<cr>

" Setup vim-easymotion
let g:EasyMotion_do_mapping=0
let g:EasyMotion_smartcase=1
map ,f <Plug>(easymotion-f)
map ,F <Plug>(easymotion-F)
map ,t <Plug>(easymotion-t)
map ,T <Plug>(easymotion-T)
map ,w <Plug>(easymotion-w)
map ,W <Plug>(easymotion-W)
map ,b <Plug>(easymotion-b)
map ,B <Plug>(easymotion-B)
map ,e <Plug>(easymotion-e)
map ,E <Plug>(easymotion-E)

" Navigation shortcuts
nnoremap <s-j> <c-f>zz
nnoremap <s-k> <c-u>zz
vnoremap <s-j> <c-f>zz
vnoremap <s-k> <c-u>zz
nnoremap j gj
nnoremap k gk

" Simplfy toggling a flag
function! ToggleFlag(option, flag)
    exec ('let lopt = &' . a:option)
    if lopt =~ (".*" . a:flag . ".*")
        exec ('set ' . a:option . '-=' . a:flag)
    else
        exec ('set ' . a:option . '+=' . a:flag)
    endif
endfunction

" Other shortcuts
nnoremap <silent> <leader>l :call ToggleFlag('formatoptions', 't')<cr>
nnoremap <silent> <leader>s :set invspell<cr>
nnoremap <silent> <leader>v :set invpaste<cr>
nnoremap <silent> <leader>C :SyntasticToggleMode<cr>
nnoremap <silent> <leader>b :windo set scrollbind!<cr>
nnoremap <silent> <leader>R :edit %<cr>
vnoremap < <gv
vnoremap > >gv
nnoremap > >>
nnoremap < <<
nnoremap <silent> <leader>Q :qa<cr>
nnoremap <silent> <leader>q :q<cr>
nnoremap <silent> <leader>w :w<cr>
nnoremap <silent> <leader>W :wa<cr>
nnoremap ; :
vnoremap ; :
nnoremap ! :!
nnoremap + <c-w>+
nnoremap = <c-w>=
nnoremap - <c-w>-
nnoremap <silent> <F5> :redraw!<cr>

" Disable Ex mode
map Q <nop>

" I don't anticpate ever using Modula-2, but I do use *.md for markdown
autocmd BufNewFile,BufReadPost *.md set filetype=markdown
" TODO add syntax file for markdown (similar to wiki)
